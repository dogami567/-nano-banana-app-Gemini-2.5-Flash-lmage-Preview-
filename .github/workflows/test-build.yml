name: Test Build (Updated)

on:
  workflow_dispatch:  # 手动触发
  push:
    paths:
      - '.github/workflows/**'
      - '*.py'
      - '*.js'
      - '*.html'
      - '*.css'

jobs:
  test-macos-build:
    runs-on: macos-13  # Use specific version to avoid migration warnings
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_macos.txt
        
    - name: Quick build test
      run: |
        echo "Testing PyInstaller basic functionality..."
        pyinstaller --version
        
        echo "Testing app.py import..."
        python -c "import app; print('✅ app.py imports successfully')"
        
        echo "Starting build..."
        echo "Current directory: $(pwd)"
        echo "Looking for spec file..."
        ls -la *.spec || echo "No .spec files found"
        
        if [ -f "macos-test.spec" ]; then
          echo "✅ Found macos-test.spec, using it"
          pyinstaller macos-test.spec
        else
          echo "⚠️  macos-test.spec not found, falling back to command line"
          pyinstaller \
            --onedir \
            --windowed \
            --name "Nano-Banana-Test" \
            --add-data "index.html:." \
            --add-data "script.js:." \
            --add-data "api.js:." \
            --add-data "utils.js:." \
            --add-data "styles.css:." \
            app.py
        fi
          
    - name: Verify test build
      run: |
        echo "Build contents:"
        ls -la dist/
        
        if [ -d "dist/Nano-Banana-Test.app" ]; then
          echo "✅ Test build successful!"
          echo "App size: $(du -sh dist/Nano-Banana-Test.app | cut -f1)"
          echo ""
          echo "App structure:"
          find dist/Nano-Banana-Test.app -type f | head -20
          echo ""
          echo "Checking for web files in Resources:"
          ls -la dist/Nano-Banana-Test.app/Contents/Resources/ || echo "Resources directory not found"
          echo ""
          echo "Verifying critical files:"
          for file in index.html script.js api.js utils.js styles.css; do
            if [ -f "dist/Nano-Banana-Test.app/Contents/Resources/$file" ]; then
              echo "✅ $file found"
            else
              echo "❌ $file missing"
            fi
          done
        else
          echo "❌ Test build failed"
          exit 1
        fi
        
    - name: Upload test build
      uses: actions/upload-artifact@v4
      with:
        name: test-build-macos
        path: dist/Nano-Banana-Test.app
        retention-days: 5

  test-windows-build:
    runs-on: windows-2022  # Use specific version to avoid migration warnings
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Quick Windows build test
      run: |
        echo "Testing Windows build..."
        pyinstaller --version
        
        pyinstaller --onefile --name "Nano-Banana-Test-Win" --add-data "index.html;." --add-data "script.js;." --add-data "api.js;." --add-data "utils.js;." --add-data "styles.css;." app.py
        
    - name: Verify Windows build
      run: |
        echo "Build contents:"
        dir dist
        
        if (Test-Path "dist/Nano-Banana-Test-Win.exe") {
          echo "✅ Windows test build successful!"
          $size = (Get-Item "dist/Nano-Banana-Test-Win.exe").Length / 1MB
          echo "Exe size: $([math]::Round($size, 1)) MB"
        } else {
          echo "❌ Windows test build failed"
          exit 1
        }
        
    - name: Upload Windows test build
      uses: actions/upload-artifact@v4
      with:
        name: test-build-windows
        path: dist/Nano-Banana-Test-Win.exe
        retention-days: 5